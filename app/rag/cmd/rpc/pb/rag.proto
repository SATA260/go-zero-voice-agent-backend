syntax = "proto3";

package rag;
option go_package = "./pb";

// 分页查询
message PageQuery {
    int64 page = 1;
    int64 page_size = 2;
    string order_by = 3;
}

message UploadFileReq {
    int64 userId = 1;
    string fileName = 2;
    string filePath = 3;
    string content_type = 4;
    int64  fileSize = 5;
    bytes  chunk = 6;
}

message UploadFileResp {
    string file_path = 1;
}

message QueryReq {
    int64 userId = 1;
    string query = 2;
    string fileId = 3;
    int32 topK = 4;
    string entityId = 5;
}

message QueryMultipleReq {
    int64 userId = 1;
    string query = 2;
    repeated string fileIds = 3;
    int32 topK = 4;
}

message RetrievalResult {
    string pageContent = 1;
    map<string, string> metadata = 2;
    double score = 3;
}

message QueryResp {
    repeated RetrievalResult results = 1;
}

message ListDocumentsFilter {
    string file_name = 1;
    string file_format = 2;
}

message ListDocumentsReq {
    int64 userId = 1;
    PageQuery pageQuery = 2;
    ListDocumentsFilter filter = 3;
}

message ListDocumentsItem {
    int64 id = 1;
    string file_name = 2;
    string file_format = 3;
    int64 status = 4; //未向量化:0  向量化:1
}

message ListDocumentsResp {
    repeated ListDocumentsItem results = 1;
    int64 total = 2;
}

message FetchDocumentsReq {
    int64 userId = 1;
    repeated string ids = 2;
}

message DocumentRecord {
    string customId = 1;
    string pageContent = 2;
    map<string, string> metadata = 3;
}

message FetchDocumentsResp {
    repeated DocumentRecord documents = 1;
}

message DeleteDocumentsReq {
    string userId = 1;
    repeated string ids = 2;
}

message DeleteDocumentsResp {
    int32 deletedCount = 1;
}

message ListChunksReq {
    int64 userId = 1;
    string fileId = 2;
    PageQuery pageQuery = 3;
}
message ListChunksResp {
    repeated DocumentRecord chunks = 1;
    int64 total = 2;
}

service DocService {
    rpc UploadFile(stream UploadFileReq) returns (UploadFileResp);
    rpc ListDocuments(ListDocumentsReq) returns (ListDocumentsResp);
    rpc FetchDocuments(FetchDocumentsReq) returns (FetchDocumentsResp);
    rpc DeleteDocuments(DeleteDocumentsReq) returns (DeleteDocumentsResp);
    rpc ListChunks(ListChunksReq) returns (ListChunksResp);
}

service RagService {
    rpc Query(QueryReq) returns (QueryResp);
    rpc QueryMultiple(QueryMultipleReq) returns (QueryResp);
}
