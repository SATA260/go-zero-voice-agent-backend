syntax = "proto3";

package llm;
option go_package="./pb";

// 分页查询
message PageQuery {
    int64 page = 1;
    int64 pageSize = 2;
    string orderBy = 3;
}



// 大语言模型配置
message LlmConfig {
    // API基础URL (必选)
    string baseUrl = 1;
    // API密钥 (必选)
    string apiKey = 2;
    // 模型名称 (必选)
    string model = 3;
    // 采样温度，控制模型生成文本的多样性 (可选)
    double temperature = 4;
    // 核采样的概率阈值 (可选)
    double topP = 5;
    // 生成过程中采样候选集的大小 (可选)
    int64 topK = 6;
    // 是否开启思考模式 (可选)
    bool enableThinking = 7;
    // 控制模型生成文本时的内容重复度（已弃用，请使用presence_penalty）(可选)
    double repetitionPenalty = 8;
    // 控制模型生成文本时的内容重复度 (可选)
    double presencePenalty = 9;
    // 返回内容的格式, e.g., "text", "json_object" (可选)
    string responseFormat = 10;
    // 流式输出特定选项 (可选)
    StreamOptions streamOptions = 11;
    // 本次请求返回的最大 Token 数 (可选)
    int64 maxTokens = 12;
    // 随机种子，用于结果可复现 (可选)
    int64 seed = 13;
    // 是否启用互联网搜索 (可选)
    bool enableSearch = 14;
    // 上下文长度 (可选)
    int64 contentLength = 15;
}
// 流式输出选项
message StreamOptions {
    // 是否在输出的最后一行显示所使用的Token数 (可选)
    bool includeUsage = 1;
}

message ToolCallInfo {
    string id = 1;
    string name = 2;
    string argumentsJson = 3;
    string scope = 4; //工具调用作用域 server/client
    bool requiresConfirmation = 5; //后端工具调用是否需要用户确认
    string description = 6; //工具描述，便于前端展示
}

// 工具调用增量信息
message ToolCall {
    ToolCallInfo info = 1; //工具调用基本信息
    string status = 2; //工具调用状态 start/executing/finished/confirmed/rejected
    string result = 3; //工具调用结果
    string error = 4; //工具调用错误信息
}

message ChatMsg {
    int64 messageId = 1; 
    string role = 2; //System,User,Assistant,tool
    string content = 3;
    repeated ToolCall toolCalls = 4;
    string toolCallId = 5;
}

// 创建聊天请求
message ChatReq {
    // 已存在的会话标识，用于继续对话（可选）
    string conversationId = 1;
    // 用户标识，用于权限校验（必选）
    int64 userId = 2;
    // 当前大模型请求配置
    LlmConfig llmConfig = 3;
    // 是否允许服务端自动回填历史记录（默认 true）
    bool autoFillHistory = 4;
    // 当创建新会话时的上下文消息（继续会话时可选）
    repeated ChatMsg messages = 5;
    // 指定的rag知识库文件ID列表（可选）
    repeated string ragFileIds = 6;
}

message ChatResp {
    string conversationId = 1;
    ChatMsg respMsg = 2;
}

message ChatStreamReq {
    // 已存在的会话标识，用于继续对话（可选）
    string conversationId = 1;
    // 用户标识，用于权限校验（必选）
    int64 userId = 2;
    // 当前大模型请求配置
    LlmConfig llmConfig = 3;
    // 是否允许服务端自动回填历史记录（默认 true）
    bool autoFillHistory = 4;
    // 当创建新会话时的上下文消息（继续会话时可选）
    repeated ChatMsg messages = 5;
     // 指定的rag知识库文件ID列表（可选）
    repeated string ragFileIds = 6;
}

message ChatStreamResp {
    string conversationId = 1;
    ChatMsg respMsg = 2;
    string error = 3;
    bool isComplete = 4;
}

// ChatConfig represents the configuration for a chat session.
message ChatConfig {
    int64 id = 1;
    string name = 2;
    string description = 3;
    int64 userId = 4;
    string baseUrl = 5;
    string apiKey = 6;
    string model = 7;
    int64 stream = 8;
    double temperature = 9;
    double topP = 10;
    int64 topK = 11;
    int64 enableThinking = 12;
    double repetitionPenalty = 13;
    double presencePenalty = 14;
    int64 maxTokens = 15;
    int64 seed = 16;
    int64 enableSearch = 17;
    int64 contextLength = 18;
}

// --- Config Management ---

// Create
message CreateConfigReq {
    string name = 1;
    string description = 2;
    int64 userId = 3;
    string baseUrl = 4;
    string apiKey = 5;
    string model = 6;
    int64 stream = 7;
    double temperature = 8;
    double topP = 9;
    int64 topK = 10;
    int64 enableThinking = 11;
    double repetitionPenalty = 12;
    double presencePenalty = 13;
    int64 maxTokens = 14;
    int64 seed = 15;
    int64 enableSearch = 16;
    int64 contextLength = 17;
}
message CreateConfigResp {
    int64 id = 1;
}

// Delete
message DeleteConfigReq {
    int64 id = 1;
}
message DeleteConfigResp {
}

// Update
message UpdateConfigReq {
    int64 id = 1;
    string name = 2;
    string description = 3;
    int64 userId = 4;
    string baseUrl = 5;
    string apiKey = 6;
    string model = 7;
    int64 stream = 8;
    double temperature = 9;
    double topP = 10;
    int64 topK = 11;
    int64 enableThinking = 12;
    double repetitionPenalty = 13;
    double presencePenalty = 14;
    int64 maxTokens = 15;
    int64 seed = 16;
    int64 enableSearch = 17;
    int64 contextLength = 18;
}
message UpdateConfigResp {
}

// Get
message GetConfigReq {
    int64 id = 1;
}
message GetConfigResp {
    ChatConfig config = 1;
}

// List
message ListConfigFilter {
    int64 id = 1;
    int64 userId = 2;
    string name = 3;
    string description = 4;
}
message ListConfigReq {
    PageQuery pageQuery = 1;
    ListConfigFilter filter = 2;
}
message ListConfigResp {
    int64 total = 1;
    repeated ChatConfig configs = 2;
}


// --- Chat Session Management ---

message ChatSession {
    int64 id = 1;
    string convId = 2;
    int64 userId = 3;
    string title = 4;
    int64 version = 5;
    int64 delState = 6;
    int64 createTime = 7;
    int64 updateTime = 8;
    int64 deleteTime = 9;
}

message CreateChatSessionReq {
    string convId = 1;
    int64 userId = 2;
    string title = 3;
}

message CreateChatSessionResp {
    int64 id = 1;
}

message DeleteChatSessionReq {
    int64 id = 1;
}

message DeleteChatSessionResp {
}

message UpdateChatSessionReq {
    int64 id = 1;
    string convId = 2;
    int64 userId = 3;
    string title = 4;
    int64 version = 5;
}

message UpdateChatSessionResp {
}

message GetChatSessionReq {
    int64 id = 1;
}

message GetChatSessionByConvIdReq {
    string convId = 1;
}

message GetChatSessionResp {
    ChatSession session = 1;
}

message ListChatSessionFilter {
    int64 id = 1;
    string convId = 2;
    int64 userId = 3;
    string title = 4;
}

message ListChatSessionReq {
    PageQuery pageQuery = 1;
    ListChatSessionFilter filter = 2;
}

message ListChatSessionResp {
    int64 total = 1;
    repeated ChatSession sessions = 2;
}


// --- Chat Message Management ---

message ChatMessage {
    int64 id = 1;
    int64 createTime = 2;
    int64 sessionId = 3;
    string role = 4;
    string content = 5;
    repeated ToolCall toolCalls = 6;
    string toolCallId = 7;
    string extra = 8;
}

message CreateChatMessageReq {
    int64 id = 1;
    int64 sessionId = 2;
    string role = 3;
    string content = 4;
    repeated ToolCall toolCalls = 5;
    string toolCallId = 6;
    string extra = 7;
}

message CreateChatMessageResp {
    int64 id = 1;
}

message DeleteChatMessageReq {
    int64 id = 1;
    int64 version = 2;
}

message DeleteChatMessageResp {
}

message UpdateChatMessageReq {
    int64 id = 1;
    int64 sessionId = 2;
    string role = 3;
    string content = 4;
    repeated ToolCall toolCalls = 5;
    string toolCallId = 6;
    string extra = 7;
}

message UpdateChatMessageResp {
}

message GetChatMessageReq {
    int64 id = 1;
}

message GetChatMessageResp {
    ChatMessage message = 1;
}

message ListChatMessageFilter {
    int64 id = 1;
    int64 sessionId = 2;
    string role = 3;
}

message ListChatMessageReq {
    PageQuery pageQuery = 1;
    ListChatMessageFilter filter = 2;
}

message ListChatMessageResp {
    int64 total = 1;
    repeated ChatMessage messages = 2;
}


service LlmChatService {
    rpc Chat(ChatReq) returns (ChatResp);
    rpc ChatStream(ChatStreamReq) returns (stream ChatStreamResp);
}

service LlmConfigService {
    rpc CreateConfig(CreateConfigReq) returns (CreateConfigResp);
    rpc DeleteConfig(DeleteConfigReq) returns (DeleteConfigResp);
    rpc UpdateConfig(UpdateConfigReq) returns (UpdateConfigResp);
    rpc GetConfig(GetConfigReq) returns (GetConfigResp);
    rpc ListConfig(ListConfigReq) returns (ListConfigResp);
}

service ChatSessionService {
    rpc CreateChatSession(CreateChatSessionReq) returns (CreateChatSessionResp);
    rpc DeleteChatSession(DeleteChatSessionReq) returns (DeleteChatSessionResp);
    rpc UpdateChatSession(UpdateChatSessionReq) returns (UpdateChatSessionResp);
    rpc GetChatSession(GetChatSessionReq) returns (GetChatSessionResp);
    rpc GetChatSessionByConvId(GetChatSessionByConvIdReq) returns (GetChatSessionResp);
    rpc ListChatSession(ListChatSessionReq) returns (ListChatSessionResp);
}

service ChatMessageService {
    rpc CreateChatMessage(CreateChatMessageReq) returns (CreateChatMessageResp);
    rpc DeleteChatMessage(DeleteChatMessageReq) returns (DeleteChatMessageResp);
    rpc UpdateChatMessage(UpdateChatMessageReq) returns (UpdateChatMessageResp);
    rpc GetChatMessage(GetChatMessageReq) returns (GetChatMessageResp);
    rpc ListChatMessage(ListChatMessageReq) returns (ListChatMessageResp);
}